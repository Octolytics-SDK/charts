{{- $appName := .Values.application.name -}}

{{/*
---
# ES 1: Global Secrets
# Creates the 'octolytics-core' secret from .Values.secrets
*/}}
{{- if .Values.secrets }}
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: {{ $appName }}
  namespace: default
spec:
  refreshInterval: "15s"
  secretStoreRef:
    name: gcp-backend
    kind: ClusterSecretStore
  target:
    name: {{ $appName }}
  data:
  {{- range .Values.secrets }}
    - secretKey: {{ .env }}
      remoteRef:
        key: {{ .key }}
  {{- end }}
{{- end }}

{{/*
---
# ES 2 & 3: Container-specific Secrets
# Loops over containers and creates ES resources for:
# 2. Secrets used as ENV vars (no mountPath)
# 3. Secrets used as VolumeMounts (has mountPath)
*/}}
{{- range .Values.containers }}
{{- $container := . }}
{{- $containerName := .name }}

  {{- /* Gather all container secrets that are NOT mounts */}}
  {{- $envSecrets := list }}
  {{- range .secrets }}
    {{- if not .mountPath }}
      {{- $envSecrets = append $envSecrets . }}
    {{- end }}
  {{- end }}

  {{- /* Gather all container secrets that ARE mounts */}}
  {{- $mountSecrets := list }}
  {{- range .secrets }}
    {{- if .mountPath }}
      {{- $mountSecrets = append $mountSecrets . }}
    {{- end }}
  {{- end }}

  {{- /* Create ES for ENV secrets (e.g., octolytics-core-api) */}}
  {{- if (gt (len $envSecrets) 0) }}
---
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: {{ $appName }}-{{ $containerName }}
  namespace: default
spec:
  refreshInterval: "15s"
  secretStoreRef:
    name: gcp-backend
    kind: ClusterSecretStore
  target:
    name: {{ $appName }}-{{ $containerName }}
  data:
    {{- range $envSecrets }}
    - secretKey: {{ .env }}
      remoteRef:
        key: {{ .key }}
    {{- end }}
  {{- end }}

  {{- /* Create ES for MOUNT secrets (e.g., octolytics-core-api-mount) */}}
  {{- if (gt (len $mountSecrets) 0) }}
---
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: {{ $appName }}-{{ $containerName }}-mount
  namespace: default
spec:
  refreshInterval: "15s"
  secretStoreRef:
    name: gcp-backend
    kind: ClusterSecretStore
  target:
    name: {{ $appName }}-{{ $containerName }}-mount
  data:
    {{- range $mountSecrets }}
    - secretKey: {{ .env }}
      remoteRef:
        key: {{ .key }}
    {{- end }}
  {{- end }}

{{- end }}